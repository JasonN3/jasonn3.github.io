"use strict";(self.webpackChunkblogs=self.webpackChunkblogs||[]).push([[164],{4137:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>u});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},d=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},m="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,s=e.originalType,l=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),m=c(a),h=i,u=m["".concat(l,".").concat(h)]||m[h]||p[h]||s;return a?n.createElement(u,r(r({ref:t},d),{},{components:a})):n.createElement(u,r({ref:t},d))}));function u(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var s=a.length,r=new Array(s);r[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[m]="string"==typeof e?e:i,r[1]=o;for(var c=2;c<s;c++)r[c]=a[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},3497:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var n=a(7462),i=(a(7294),a(4137));const s={sidebar_label:"Joining AD",sidebar_position:1},r="Joining RHEL or any other Linux machine directly to Microsoft Active Directory",o={unversionedId:"RH/active-directory/join-ad",id:"RH/active-directory/join-ad",title:"Joining RHEL or any other Linux machine directly to Microsoft Active Directory",description:"Managing access to Linux machines on your network can be challenging. I've seen admins create all users on all machines, others that share accounts using SSH keys or even passwords, and still others that use LDAP binding (sometimes using the existing Active Directory infrastructure and sometimes using a separate domain) which requires them to write LDAP queries to filter access. All these methods make managing access to machines difficult, and they require the admins to be informed when someone has left or joined a team. Shared accounts can make logging mostly useless as everyone will have the same username. And I'm probably not alone in having a bad experience with HR informing technical teams when there's a change to a team. However, there's a way I've found that works well and integrates with what is typically a pre-existing process.",source:"@site/docs/RH/active-directory/join-ad.md",sourceDirName:"RH/active-directory",slug:"/RH/active-directory/join-ad",permalink:"/RH/active-directory/join-ad",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_label:"Joining AD",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Active Directory",permalink:"/category/active-directory"},next:{title:"RealmD",permalink:"/RH/active-directory/realm"}},l={},c=[{value:"Configuring your AD groups for RBAC (Role Based Access Control)",id:"configuring-your-ad-groups-for-rbac-role-based-access-control",level:2},{value:"Access to specific machines",id:"access-to-specific-machines",level:3},{value:"Access to all machines",id:"access-to-all-machines",level:3},{value:"Nesting",id:"nesting",level:3},{value:"Domain Joining your Linux machine",id:"domain-joining-your-linux-machine",level:2},{value:"Keeping the OS information up to date",id:"keeping-the-os-information-up-to-date",level:2},{value:"Enabling Smartcard authentication",id:"enabling-smartcard-authentication",level:2},{value:"Enable SSH access using the smartcard certificate",id:"enable-ssh-access-using-the-smartcard-certificate",level:3},{value:"Additional Information",id:"additional-information",level:2}],d={toc:c},m="wrapper";function p(e){let{components:t,...a}=e;return(0,i.kt)(m,(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"joining-rhel-or-any-other-linux-machine-directly-to-microsoft-active-directory"},"Joining RHEL or any other Linux machine directly to Microsoft Active Directory"),(0,i.kt)("p",null,"Managing access to Linux machines on your network can be challenging. I've seen admins create all users on all machines, others that share accounts using SSH keys or even passwords, and still others that use LDAP binding (sometimes using the existing Active Directory infrastructure and sometimes using a separate domain) which requires them to write LDAP queries to filter access. All these methods make managing access to machines difficult, and they require the admins to be informed when someone has left or joined a team. Shared accounts can make logging mostly useless as everyone will have the same username. And I'm probably not alone in having a bad experience with HR informing technical teams when there's a change to a team. However, there's a way I've found that works well and integrates with what is typically a pre-existing process."),(0,i.kt)("p",null,"Most companies I've come across have some form of ERP system that automatically creates, disables, or deletes user accounts in Microsoft Active Directory (AD), so let's take advantage of the work that others are doing. ",(0,i.kt)("a",{parentName:"p",href:"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_authentication_and_authorization_in_rhel/understanding-sssd-and-its-benefits_configuring-authentication-and-authorization-in-rhel"},"SSSD")," can connect directly to AD. If you've ever set up an authentication server for Linux that had a trust to AD, you've had SSSD talk to your AD servers. If you look at ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/active-directory-domain-services/concepts-forest-trust#kerberos-based-processing-of-authentication-requests-over-forest-trusts"},"how a trust works"),", the authentication server you set up returns a referral back to the AD servers causing SSSD to query your AD servers directly. The following setup skips the need for the extra authentication server and configures SSSD to go directly to AD first. "),(0,i.kt)("p",null,"The next question is typically how to control access. This is where ",(0,i.kt)("a",{parentName:"p",href:"https://www.dnsstuff.com/rbac-vs-abac-access-control#what-is-rbac"},"RBAC"),' comes in. RBAC allows you to stop assigning access to users and start assigning access to roles. Once you have the groups laid out, you can assign a new team member to a team, which is already a part of the role with appropriate access to a group of servers. It removes the "I just got hired and need the same access as X" requests that reference a person who left months ago and had all of their access purged. Instead, once you add the new user to their team\'s group, they have the access they need. It also removes the discovery that someone who left the company over a year ago still has access to all the servers because nobody told the admins that that person left. When the ERP system automatically updates their AD account, they lose all access.'),(0,i.kt)("p",null,"Managing AD from non-Windows operating systems was once challenging. However, Microsoft has released ",(0,i.kt)("a",{parentName:"p",href:"https://www.microsoft.com/en-us/windows-server/windows-admin-center"},"Windows Admin Center")," allowing you to access Active Directory Users and Computers directly from any browser running on any operating system. It also grants access to various other Windows management tools. It can be installed on a Windows server and then there\u2019s no worrying about session limits or mucking around with RemoteApp. You just launch a browser and access the web interface."),(0,i.kt)("h2",{id:"configuring-your-ad-groups-for-rbac-role-based-access-control"},"Configuring your AD groups for RBAC (Role Based Access Control)"),(0,i.kt)("p",null,"Your company's naming scheme may differ from the examples in this article. The group names are not important. The essential part is the intended use of each group."),(0,i.kt)("p",null,"Because SSSD is not synchronizing AD groups, and instead is just getting a list of groups the user is a member of during the login process, missing groups don't prevent this setup from working. However, if you have multiple teams with delegated permissions within AD, it is recommended to create all of the groups to prevent them from being created in the incorrect organizational unit (OU) and giving the wrong team control over access."),(0,i.kt)("h3",{id:"access-to-specific-machines"},"Access to specific machines"),(0,i.kt)("p",null,"For each machine, create two groups. Both groups will include the short name of the machine.",(0,i.kt)("br",{parentName:"p"}),"\n","One group is for machine-specific ",(0,i.kt)("inlineCode",{parentName:"p"},"SSH")," access (referred to as",(0,i.kt)("inlineCode",{parentName:"p"},"<Machine_SSH_Access>")," for the rest of this article).",(0,i.kt)("br",{parentName:"p"}),"\n","The other group is for machine-specific ",(0,i.kt)("inlineCode",{parentName:"p"},"sudo")," access (referred to as ",(0,i.kt)("inlineCode",{parentName:"p"},"<Machine_SUDO_Access>")," for the rest of the doc)."),(0,i.kt)("p",null,"  Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"<DOMAIN> Linux <hostname> ssh access\n<DOMAIN> Linux <hostname> sudo access\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"<hostname>")," is the shortname of the machine  "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"<DOMAIN>")," is your domain's short name (optional)")),(0,i.kt)("h3",{id:"access-to-all-machines"},"Access to all machines"),(0,i.kt)("p",null,"Create two groups within Active Directory for global machine access."),(0,i.kt)("p",null,"One group is for SSH access to all machines (referred to as ",(0,i.kt)("inlineCode",{parentName:"p"},"<Global_SSH_Access>")," for the rest of this article).\nThe other group is for sudo access to all machines (referred to as ",(0,i.kt)("inlineCode",{parentName:"p"},"<Global_SSH_Access>")," for the rest of this article)."),(0,i.kt)("p",null,"  Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"<DOMAIN> Linux ssh access\n<DOMAIN> Linux sudo access\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"<DOMAIN>")," is your domain's short name (optional)")),(0,i.kt)("h3",{id:"nesting"},"Nesting"),(0,i.kt)("p",null,"Nesting within the AD groups is allowed. If you want to create a group with access to multiple machines, you do not need to change the configuration on the RHEL machines. Instead, you can make the new group a member of the access group for the specific machines. This approach allows you to control the access directly from AD."),(0,i.kt)("p",null,"Example nesting:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"- CONTOSO Linux Webserver1 ssh access\n  - CONTOSO Linux Webservers ssh access\n    - CONTOSO Web Developers\n      - User1\n      - User2\n")),(0,i.kt)("p",null,"This nesting allows you to assign roles (CONTOSO Web Developers) to groups of machines (CONTOSO Linux Webservers ssh access) instead of users to specific machines."),(0,i.kt)("h2",{id:"domain-joining-your-linux-machine"},"Domain Joining your Linux machine"),(0,i.kt)("p",null,"If your environment currently has RC4 enabled, please follow ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/security-updates/SecurityAdvisories/2013/2868725?redirectedfrom=MSDN"},"Microsoft\u2019s Security Advisory")," and disable it now."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install required packages"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"dnf install -y chrony krb5-workstation samba-common-tools oddjob-mkhomedir samba-common sssd authselect\n")),(0,i.kt)("p",{parentName:"li"},"If you are not using RHEL or a related distro, the package names may differ slightly.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add your domain\u2019s CA chain\nCreate ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/pki/sssd_auth_ca_db.pem")," and write your domain\u2019s CA chain. This does not need to include the certificate for the DCs themselves. It can start at the certificate that signed their certificates"))),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add the CA chain to the machine's trust anchors"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"trust anchor /etc/sssd/pki/sssd_auth_ca_db.pem\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configure SSSD by editing ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/sssd.conf")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/conf.d/<DOMAIN>.conf")," and match the following lines.\nEditing ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/conf.d/<DOMAIN>.conf")," is the modern and preferred method, but editing ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/sssd.conf")," also works."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/etc/sssd/sssd.conf"',title:'"/etc/sssd/sssd.conf"'},"[domain/<DOMAIN>]\naccess_provider = simple\nauth_provider = ad\nchpass_provider = ad\nid_provider = ad\ndyndns_update = true\noverride_homedir = /home/%u\noverride_shell = /bin/bash\ndefault_shell = /bin/bash\nldap_idmap_range_size = 4000000\ncache_credentials = true\nsimple_allow_groups = <Global_SSH_Access>, <Global_SUDO_Access>, <Machine_SSH_Access>, <Machine_SUDO_Access>\nignore_group_members = true\nad_gpo_access_control = disabled\nad_enable_gc = false\n[sssd]\nservices = nss, pam\nconfig_file_version = 2\ndomains = <DOMAIN>\n")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"<DOMAIN>")," is the FQDN of your domain in ALL CAPITALS. Authentication issues can occur if you do not use all capitals.  "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ldap_idmap_range_size")," is optional. This is necessary if you have a large AD environment. Changing this value will cause the uid hash to change so make sure all machines have the same value and do not to change it once the machine is domain joined.  "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"<Global_SSH_Access>"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"<Global_SUDO_Access>"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"<Machine_SSH_Access>"),", and ",(0,i.kt)("inlineCode",{parentName:"li"},"<Machine_SUDO_Access>")," are the AD groups you created above for RBAC"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Set the permissions for the file you just wrote:",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/sssd.conf")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/conf.d/<DOMAIN>.conf")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 400 /etc/sssd/sssd.conf\n")),(0,i.kt)("p",{parentName:"li"},"or"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 400 /etc/sssd/conf.d/*.conf\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configure KRB5 by editing /etc/krb5.conf and match these lines:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/etc/krb5.conf"',title:'"/etc/krb5.conf"'},"[logging]\ndefault = FILE:/var/log/krb5libs.log\nkdc = FILE:/var/log/krb5kdc.log\nadmin_server = FILE:/var/log/kadmind.log\n\n[libdefaults]\ndns_lookup_realm = true\ndns_lookup_kdc = true\nticket_lifetime = 24h\nrenew_lifetime = 7d\nforwardable = true\nrdns = true\ndefault_ccache_name = KEYRING:persistent:%{uid}\ndefault_realm = <DOMAIN>\n\n[realms]\n\n[domain_realm]\n")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"<DOMAIN>")," is the FQDN of your domain in ALL CAPITALS. Authentication issues will occur if you do not use all capitals.  "),(0,i.kt)("li",{parentName:"ul"},"You do not need to specify anything under ",(0,i.kt)("inlineCode",{parentName:"li"},"realms")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"domain_realm"),". SSSD will automatically discover that information from DNS."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configure SUDO access by creating a file in /etc/sudoers.d:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"visudo -f /etc/sudoers.d/<DOMAIN>\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sudo",metastring:'title="/etc/sudoers.d/<DOMAIN>"',title:'"/etc/sudoers.d/<DOMAIN>"'},"%<Global_SUDO_Access>  ALL=(ALL) ALL\n%<Machine_SUDO_Access>  ALL=(ALL) ALL\n")),(0,i.kt)("admonition",{parentName:"li",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"The file name can be anything you want, and doesn't have to be named ",(0,i.kt)("inlineCode",{parentName:"p"},"<DOMAIN>"))),(0,i.kt)("admonition",{parentName:"li",title:"Using spaces",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Make sure to escape any spaces with a ",(0,i.kt)("inlineCode",{parentName:"p"},"\\"),(0,i.kt)("br",{parentName:"p"}),"\n","Example: \u201cLinux sudo access\u201d becomes \u201cLinux\\ sudo\\ access\u201d")),(0,i.kt)("admonition",{parentName:"li",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"sudo")," access to other AD groups can be defined the same way in separate files or in the same file."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Ensure the machine's hostname is set to the FQDN. The machine hostname cannot be the shortname"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"hostnamectl set-hostname $(hostname -f)\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Join the machine with one of the following commands (adcli is compatible with SMBv1 and SMBv2)."),(0,i.kt)("p",{parentName:"li"}," To set the OS information within AD while joining, use the following command:  "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'source /etc/os-release\nadcli join -U <join_user> --os-name="${NAME}" --os-version="${VERSION}" --os-service-pack="${VERSION_ID}"\n')),(0,i.kt)("p",{parentName:"li"},"Alternately, you can join without setting the OS information:  "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"adcli join -U <join_user>\n")),(0,i.kt)("p",{parentName:"li"},"   ",(0,i.kt)("inlineCode",{parentName:"p"},"<join_user>")," is the AD account that will be used to join the machine to the domain. The password that adcli requests is not stored. ",(0,i.kt)("a",{parentName:"p",href:"https://www.mankier.com/8/adcli#Delegated_Permissions"},"Delegated Permissions")," describes the permissions required for joining")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Enable and start SSSD and oddjobd"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable sssd oddjobd\nsystemctl restart sssd oddjobd\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Enable logging in with AD"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"authselect select sssd with-mkhomedir --force\n")))),(0,i.kt)("p",null,"As long as your account is a member of one of the groups you created, you can now log in to the machine. You don't need to specify the domain. The domain specified as the ",(0,i.kt)("inlineCode",{parentName:"p"},"default_realm")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/krb5.conf")," is used. GNOME may require a restart, but sshd is typically happy to accept the changes without a restart."),(0,i.kt)("h2",{id:"keeping-the-os-information-up-to-date"},"Keeping the OS information up to date"),(0,i.kt)("p",null,"By default, the computer object doesn't have permission to update its own OS information. Make sure to go into Active Directory Users and Computers (ADUAC) and grant ",(0,i.kt)("inlineCode",{parentName:"p"},"SELF")," the ability to write each of the OS fields on the computer objects (you can do this at the OU level). Once added, the following commands can be used to update the AD object with the latest OS information:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'source /etc/os-release\n/usr/sbin/adcli update --os-name="${NAME}" --os-version="${VERSION}" --os-service-pack="${VERSION_ID}"\n')),(0,i.kt)("p",null,"This can either be added as a cron job or as a systemd service",(0,i.kt)("br",{parentName:"p"}),"\n","Example service:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/etc/systemd/system/update-ad.service"',title:'"/etc/systemd/system/update-ad.service"'},'[Unit]\nDescription=Updates AD with the current OS information\nAfter=sssd.service\n\n[Service]\nType=oneshot\nEnvironmentFile=/etc/os-release\nExecStart=/usr/sbin/adcli update --os-name="${NAME}" --os-version="${VERSION}" --os-service-pack="${VERSION_ID}"\n\n[Install]\nWantedBy=multi-user.target\n')),(0,i.kt)("h2",{id:"enabling-smartcard-authentication"},"Enabling Smartcard authentication"),(0,i.kt)("p",null,"This section assumes you have smart card authentication working on your Windows machines. If not, configure smart card authentication on a Windows machine before proceeding."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Write the certificate chain for your domain to ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/pki/sssd_auth_ca_db.pem"),". This does not need to include the certificate for the Domain Controllers (DCs) themselves. It can start with the certificate that signed their certificates.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add the certificate to the machines trusted CA list."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"trust anchor /etc/sssd/pki/sssd_auth_ca_db.pem\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Edit ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/sssd.conf")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/sssd/conf.d/<DOMAIN>.conf"),", depending on which file you used when you domain joined your machine, and add the following line within the ",(0,i.kt)("inlineCode",{parentName:"p"},"[domain/<DOMAIN>]")," section.",(0,i.kt)("br",{parentName:"p"}),"\n","This entry tells SSSD where to look for the user certificate. Windows uses the attribute ",(0,i.kt)("inlineCode",{parentName:"p"},"userCertificate"),", so if we use the same attribute, the same smart card works on both Linux and Windows."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/etc/sssd/sssd.conf"',title:'"/etc/sssd/sssd.conf"'},"ldap_user_certificate = userCertificate;binary\n")),(0,i.kt)("p",{parentName:"li"},"Add these lines at the end of the same configuration file:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/etc/sssd/sssd.conf"',title:'"/etc/sssd/sssd.conf"'},"[pam]\npam_cert_auth = true\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Edit ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/krb5.conf")," and add the following lines under ",(0,i.kt)("inlineCode",{parentName:"p"},"[realms]")," replacing ",(0,i.kt)("inlineCode",{parentName:"p"},"<DOMAIN>")," with your domain's FQDN in ALL CAPITALS. This is to resolve a mismatch that can occur because Linux is case senstive while Windows is not."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/etc/krb5.conf"',title:'"/etc/krb5.conf"'},"<DOMAIN> = {\n  pkinit_anchors = DIR:/etc/sssd/pki\n  pkinit_kdc_hostname = <DOMAIN>\n}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Use one of the following commands to enable smartcard authentication in PAM"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"authselect enable-feature with-smartcard"),(0,i.kt)("br",{parentName:"li"}),"This will allow smartcard authentication as an option"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"authselect enable-feature with-smartcard-required"),(0,i.kt)("br",{parentName:"li"}),"This will require smartcard authentication. Please remember that, by default, SSHd will not call PAM when authenticating with SSH keys"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"authselect enable-feature with-smartcard-lock-on-removal"),(0,i.kt)("br",{parentName:"li"}),"This will require smartcard authentication and will lock the machine when the smartcard is removed. Please remember that, by default, SSHd will not call PAM when authenticating with SSH keys")))),(0,i.kt)("h3",{id:"enable-ssh-access-using-the-smartcard-certificate"},"Enable SSH access using the smartcard certificate"),(0,i.kt)("p",null,"On RHEL 8 and above, you can enable SSH access using a smart card.  "),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Verify that the smart card cert is read properly from AD:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sss_ssh_authorizedkeys ${USER}\n")),"If a public key is not returned, verify that smartcard authentication is configured properly"),(0,i.kt)("li",{parentName:"ol"},"Edit ",(0,i.kt)("inlineCode",{parentName:"li"},"/etc/ssh/sshd_config")," and add these lines",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="/etc/ssh/sshd_config"',title:'"/etc/ssh/sshd_config"'},"AuthorizedKeysCommand /usr/bin/sss_ssh_authorizedkeys\nAuthorizedKeysCommandUser nobody\n"))),(0,i.kt)("li",{parentName:"ol"},"Restart ",(0,i.kt)("inlineCode",{parentName:"li"},"sshd"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart sshd\n")))),(0,i.kt)("p",null,"To log in from a client using SSH, use the option `PKCS11Provider=/usr/lib64/opensc-pkcs11.so``. As long as the smart card matches a public key for the user, you will be prompted for the smart card PIN or password:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ssh -o PKCS11Provider=/usr/lib64/opensc-pkcs11.so <host>\n")),(0,i.kt)("h2",{id:"additional-information"},"Additional Information"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Disabling a user within AD will immediately block access to the machine. Just like with Windows, anyone who is already logged in will stay logged in."),(0,i.kt)("li",{parentName:"ul"},"Modification to the user's groups is updated during login just like Windows. This is done before checking if they are allowed to log in."),(0,i.kt)("li",{parentName:"ul"},"SSSD is site aware. If you configure sites within Sites and Services, SSSD will connect to the appropriate DC."),(0,i.kt)("li",{parentName:"ul"},"SSSD will automatically rotate the computer password."),(0,i.kt)("li",{parentName:"ul"},"SSSD will automatically create and manage the DNS records for the machine as long as dynamic updates (secure or insecure) are enabled.")),(0,i.kt)("p",null,"I typically discourage using Windows tools to manage Linux systems and Linux tools to manage Windows because there are usually important features lost, security missing, or much easier ways to accomplish the same task with a native tool. However, it's different with AD. The developers of SSSD have done a lot of work to make it compatible with AD, and in the end that makes your job all the easier. Years ago, trying to use AD with Linux meant writing LDAP queries and creating mapping files. Nowadays, none of that is needed."))}p.isMDXComponent=!0}}]);