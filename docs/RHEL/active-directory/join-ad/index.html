<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-RHEL/active-directory/join-ad">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Joining RHEL or any other Linux machine directly to Microsoft Active Directory | Jason Nagin&#x27;s Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jasonn3.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jasonn3.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jasonn3.github.io/docs/RHEL/active-directory/join-ad"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Joining RHEL or any other Linux machine directly to Microsoft Active Directory | Jason Nagin&#x27;s Docs"><meta data-rh="true" name="description" content="Managing access to Linux systems is always a challenge. I&#x27;ve seen some people create all of their user&#x27;s on all of their machines, others that will share accounts either through SSH keys or passwords, and others that will use LDAP binding (sometimes using the existing AD infrastructure and sometimes using a separate domain) that required them to write LDAP queries to filter access. All of these methods make managing access to machines difficult, require the administrators to be informed when someone is joining or leaves a team, and sometimes makes logging useless (shared accounts). I&#x27;m sure I&#x27;m also not alone in having a bad experience with HR informing the technical teams when there is a change to teams. However, there&#x27;s a way I&#x27;ve found that works well and integrates with what is typically a pre-existing process."><meta data-rh="true" property="og:description" content="Managing access to Linux systems is always a challenge. I&#x27;ve seen some people create all of their user&#x27;s on all of their machines, others that will share accounts either through SSH keys or passwords, and others that will use LDAP binding (sometimes using the existing AD infrastructure and sometimes using a separate domain) that required them to write LDAP queries to filter access. All of these methods make managing access to machines difficult, require the administrators to be informed when someone is joining or leaves a team, and sometimes makes logging useless (shared accounts). I&#x27;m sure I&#x27;m also not alone in having a bad experience with HR informing the technical teams when there is a change to teams. However, there&#x27;s a way I&#x27;ve found that works well and integrates with what is typically a pre-existing process."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jasonn3.github.io/docs/RHEL/active-directory/join-ad"><link data-rh="true" rel="alternate" href="https://jasonn3.github.io/docs/RHEL/active-directory/join-ad" hreflang="en"><link data-rh="true" rel="alternate" href="https://jasonn3.github.io/docs/RHEL/active-directory/join-ad" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Jason Nagin&#39;s Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Jason Nagin&#39;s Docs Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8418b215.css">
<link rel="preload" href="/assets/js/runtime~main.8067824e.js" as="script">
<link rel="preload" href="/assets/js/main.958d5789.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Home" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Home" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/red-hat">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div><a href="https://github.com/jasonn3/jasonn3.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/red-hat">Red Hat</a><button aria-label="Toggle the collapsible sidebar category &#x27;Red Hat&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/active-directory">Active Directory</a><button aria-label="Toggle the collapsible sidebar category &#x27;Active Directory&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/RHEL/active-directory/join-ad">Join AD</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/red-hat"><span itemprop="name">Red Hat</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/active-directory"><span itemprop="name">Active Directory</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Join AD</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Joining RHEL or any other Linux machine directly to Microsoft Active Directory</h1><p>Managing access to Linux systems is always a challenge. I&#x27;ve seen some people create all of their user&#x27;s on all of their machines, others that will share accounts either through SSH keys or passwords, and others that will use LDAP binding (sometimes using the existing AD infrastructure and sometimes using a separate domain) that required them to write LDAP queries to filter access. All of these methods make managing access to machines difficult, require the administrators to be informed when someone is joining or leaves a team, and sometimes makes logging useless (shared accounts). I&#x27;m sure I&#x27;m also not alone in having a bad experience with HR informing the technical teams when there is a change to teams. However, there&#x27;s a way I&#x27;ve found that works well and integrates with what is typically a pre-existing process. </p><p>Most companies I have come across have some form of ERP system that will automatically create/disable/delete user accounts in Microsoft Active Directory (MS AD), so let&#x27;s take advantage of the work that others are doing. <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_authentication_and_authorization_in_rhel/understanding-sssd-and-its-benefits_configuring-authentication-and-authorization-in-rhel" target="_blank" rel="noopener noreferrer">SSSD</a> can connect directly to MS AD. If you&#x27;ve ever set up an authentication server for Linux that had a trust to AD, you&#x27;ve had SSSD talk to your AD servers. If you look at <a href="https://learn.microsoft.com/en-us/azure/active-directory-domain-services/concepts-forest-trust#kerberos-based-processing-of-authentication-requests-over-forest-trusts" target="_blank" rel="noopener noreferrer">how a trust works</a>, the authentication server you setup would have returned a referral back to the MS AD servers causing SSSD to query your AD servers directly. The following setup skips the need for the extra authentication server and configures SSSD to go directly to AD first.</p><p>The next question is typically how to control access. This is where RBAC comes in. RBAC gives you the ability to stop assigning access to users and start assigning access to roles. For a description of RBAC, please check out DNSStuff&#x27;s article on <a href="https://www.dnsstuff.com/rbac-vs-abac-access-control#what-is-rbac" target="_blank" rel="noopener noreferrer">what is RBAC</a>. Once you have the groups laid out, a new team member can automatically be assigned to a team, which will already be a part of the role, which will already have the appropriate access to a group of servers. It removes the &quot;I just got hired and need the same access as X&quot; requests that reference a person that left months ago and has had all of their access purged. Instead, once they are added to their team&#x27;s group, they&#x27;ll have the access they need. It also removes the discoveries that someone that left the company over a year ago still has access to all of the servers because nobody told the administrators that that person left the company. When the ERP system automatically updates their AD account, they&#x27;ll lose all access.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-your-ad-groups-for-rbac-role-based-access-control">Configuring your AD groups for RBAC (Role Based Access Control)<a href="#configuring-your-ad-groups-for-rbac-role-based-access-control" class="hash-link" aria-label="Direct link to Configuring your AD groups for RBAC (Role Based Access Control)" title="Direct link to Configuring your AD groups for RBAC (Role Based Access Control)">​</a></h2><p>Your company&#x27;s naming scheme may differ from the examples below. The name of the groups are not important. The important part is the intended use of each group.
Because SSSD is not synchronizing the AD groups and instead is just getting a list of groups the user is a part of as part of the login process, missing groups will not prevent this setup from working. However, if you have multiple teams with delegated permissions, it is recommended to at least create all of the groups to prevent them from being created in the wrong OU and giving the wrong team control over the access</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="access-to-specific-machines">Access to specific machines<a href="#access-to-specific-machines" class="hash-link" aria-label="Direct link to Access to specific machines" title="Direct link to Access to specific machines">​</a></h3><ul><li><p>For each machine create two groups. Both groups will include the short name of the machine.<br>
<!-- -->One of the groups will be for machine specific <code>SSH</code> access (Referred to as <code>*Machine_SSH_Access*</code> for the rest of the doc).<br>
<!-- -->The other will be machine specific <code>SUDO</code> access (Referred to as <code>*Machine_SUDO_Access*</code> for the rest of the doc).  </p><p>Example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">*DOMAIN* Linux *hostname* ssh access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*DOMAIN* Linux *hostname* sudo access</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>*hostname*</code> is the shortname of the machine<br>
<code>*DOMAIN*</code> is your domain&#x27;s short name (optional)</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="access-to-all-machines">Access to all machines<a href="#access-to-all-machines" class="hash-link" aria-label="Direct link to Access to all machines" title="Direct link to Access to all machines">​</a></h3><ul><li><p>Create two groups for global machine access.<br>
<!-- -->One of the groups will be for <code>SSH</code> access (Referred to as <code>*Global_SSH_Access*</code> for the rest of the doc) to all machines.<br>
<!-- -->The other will be for <code>SUDO</code> access (Referred to as <code>*Global_SSH_Access*</code> for the rest of the doc) to all machines.  </p><p>Example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">*DOMAIN* Linux ssh access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*DOMAIN* Linux sudo access</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>*DOMAIN*</code> is your domain&#x27;s short name (optional)</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nesting">Nesting<a href="#nesting" class="hash-link" aria-label="Direct link to Nesting" title="Direct link to Nesting">​</a></h3><p>Nesting within the AD groups is allowed. If you would like to create a group that has access to multiple machines, you do not need to change the configuration on the RHEL machine. Instead you can make the new group a member of the access group for the specific machines. This will allow you to control the access directly from AD.</p><p>Example nesting:</p><ul><li>CONTOSO Linux Webserver1 ssh access<ul><li>CONTOSO Linux Webservers ssh access<ul><li>CONTOSO Web Developers<ul><li>User1</li><li>User2</li></ul></li></ul></li></ul></li></ul><p>This nesting will allow you to assign roles (CONTOSO Web Developers) to groups of machines (CONTOSO Linux Webservers ssh access) instead of users to specific machines.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-joining-your-linux-machine">Domain Joining your Linux machine<a href="#domain-joining-your-linux-machine" class="hash-link" aria-label="Direct link to Domain Joining your Linux machine" title="Direct link to Domain Joining your Linux machine">​</a></h2><ol><li><p>Install required packages</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dnf </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y chrony krb5-workstation samba-common-tools oddjob-mkhomedir samba-common sssd authselect</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you aren&#x27;t using RHEL or a related distro, the package names may differ slightly.</p></li><li><p>Configure SSSD</p><p>Edit <code>/etc/sssd/sssd.conf</code> and match the following lines:</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/etc/sssd/sssd.conf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[domain/*DOMAIN*]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">access_provider = simple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth_provider = ad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chpass_provider = ad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id_provider = ad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dyndns_update = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">override_homedir = /home/%u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">override_shell = /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_shell = /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ldap_idmap_range_size = 4000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cache_credentials = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">simple_allow_groups = *Global_SSH_Access*, *Global_SUDO_Access*, *Machine_SSH_Access*, *Machine_SUDO_Access*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ignore_group_members = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ad_gpo_access_control = disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ad_enable_gc = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[sssd]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services = nss, pam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config_file_version = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">domains = *DOMAIN*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>*DOMAIN*</code> is the FQDN of your domain in ALL CAPITALS. Authentication issues will occur if you do not use all capitals.<br>
<code>ldap_idmap_range_size</code> is optional. This is necessary if you have a large AD environment. Changing this value will cause the uid hash to change so make sure not to change it once the machine is domain joined.<br>
<code>*Global_SSH_Access*</code>, <code>*Global_SUDO_Access*</code>, <code>*Machine_SSH_Access*</code>, and <code>*Machine_SUDO_Access*</code> are the AD groups you created above for RBAC</p><p>If you would like to enable LDAPS (recommended), add the CA chain to the trust anchors and then add <code>ad_use_ldaps = true</code> under the domain section</p></li><li><p>Set the permissions for <code>/etc/sssd/sssd.conf</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">400</span><span class="token plain"> /etc/sssd/sssd.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Configure KRB5</p><p>Edit <code>/etc/krb5.conf</code> and match the following lines</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[logging]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default = FILE:/var/log/krb5libs.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kdc = FILE:/var/log/krb5kdc.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">admin_server = FILE:/var/log/kadmind.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[libdefaults]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dns_lookup_realm = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dns_lookup_kdc = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ticket_lifetime = 24h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">renew_lifetime = 7d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">forwardable = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rdns = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_ccache_name = KEYRING:persistent:%{uid}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_realm = *DOMAIN*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[realms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[domain_realm]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`*DOMAIN*` is the FQDN of your domain in ALL CAPITALS. Authentication issues will occur if you do not use all capitals.  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You do not need to specify anything under `realms` or `domain_realm`. SSSD will automatically discover that information from DNS.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li><p>Configure SUDO access</p><p>Create a file in /etc/sudoers.d using <code>visudo -f /etc/sudoers.d/DOMAIN</code> and specify the default sudo access for members of the AD <code>SUDO</code> groups. The file name can be anything you want and does not have to be named <code>DOMAIN</code>.  </p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Using spaces</div><div class="admonitionContent_S0QG"><p>Make sure to escape any spaces with a <code>\</code></p></div></div><p>  Example: <code>Linux sudo access</code> becomes <code>Linux\ sudo\ access</code>  </p><div class="language-sudo codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sudo codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">%*Global_SUDO_Access*   ALL=(ALL) ALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%*Machine_SUDO_Access*  ALL=(ALL) ALL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>*Global_SUDO_Access*</code> and <code>*Machine_SUDO_Access*</code> are the AD groups you created above for RBAC.<br>
<!-- -->The <code>%</code> before the group name indicates that it is a group</p><p>Any other sudo access you would like to grant to AD groups can be defined the same way in separate files or in the same file</p></li><li><p>Ensure the machine&#x27;s hostname is set to the FQDN. The machine hostname cannot be the shortname</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hostnamectl set-hostname </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">hostname</span><span class="token variable" style="color:#36acaa"> -f</span><span class="token variable" style="color:#36acaa">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Join the machine with one of the following commands</p><ul><li>Join with OS information. The OS information is only set during joining.<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">source</span><span class="token plain"> /etc/os-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adcli </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> -U *join_user* --os-name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${NAME}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> --os-version</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${VERSION}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> --os-service-pack</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${VERSION_ID}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><code>*join_user*</code> is the AD account that will be used to join the machine to the domain. The password that adcli prompts for will not be stored anywhere. <a href="https://www.mankier.com/8/adcli#Delegated_Permissions" target="_blank" rel="noopener noreferrer">Delegated Permissions</a> describes the permissions required for joining</li><li>Join without OS information<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adcli </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> -U *join_user*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div> <code>*join_user*</code> is the AD account that will be used to join the machine to the domain. The password that adcli prompts for will not be stored anywhere. <a href="https://www.mankier.com/8/adcli#Delegated_Permissions" target="_blank" rel="noopener noreferrer">Delegated Permissions</a> describes the permissions required for joining</li></ul></li><li><p>Enable and start SSSD and oddjobd</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> sssd oddjobd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart sssd oddjobd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Enable logging in with AD</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">authselect </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> sssd with-mkhomedir --force</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>As long as your account is a member of one of the groups that were created, you should now be able to log in to the machine. You do not need to specify the domain. The domain specified as the <code>default_realm</code> in <code>/etc/krb5.conf</code> will be used. Gnome is sometimes a little finicky and may require a restart, but SSHd is typically happy to accept the changes without a restart.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="keeping-the-os-information-up-to-date">Keeping the OS information up to date<a href="#keeping-the-os-information-up-to-date" class="hash-link" aria-label="Direct link to Keeping the OS information up to date" title="Direct link to Keeping the OS information up to date">​</a></h2><p>By default, the computer object will not have enough permissions to update its own OS information. Make sure to go in to ADUAC (Active Directory Users and Computers) and grant <code>SELF</code> the ability to write each of the OS fields on the computer objects (this can be done at the OU level). Once added, the following commands can be used to update the AD object with the latest OS information</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">source</span><span class="token plain"> /etc/os-release</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> /usr/sbin/adcli update --os-name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${NAME}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> --os-version</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${VERSION}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> --os-service-pack</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${VERSION_ID}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This can either be added as a cron job or as a systemd service<br>
<!-- -->Example service:</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=Updates AD with the current OS information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After=sssd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=oneshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EnvironmentFile=/etc/os-release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/sbin/adcli update --os-name=&quot;${NAME}&quot; --os-version=&quot;${VERSION}&quot; --os-service-pack=&quot;${VERSION_ID}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-smartcard-authentication">Enabling Smartcard authentication<a href="#enabling-smartcard-authentication" class="hash-link" aria-label="Direct link to Enabling Smartcard authentication" title="Direct link to Enabling Smartcard authentication">​</a></h2><ol><li><p>Write the certificate chain for your domain to <code>/etc/sssd/pki/sssd_auth_ca_db.pem</code>. This does not need to include the certificate for the DCs themselves. It can start at the certificate that signed their certificate</p></li><li><p>Add the certificate to the machines trusted CA list</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">trust anchor /etc/sssd/pki/sssd_auth_ca_db.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Edit <code>/etc/sssd/sssd.conf</code></p><p>Add the following line within the <code>[domain/*DOMAIN*]</code> section. This will tell SSSD where to look for the certificate. <code>userCertificate</code> is the same location Windows uses so the same smartcard will work on both Linux and Windows</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ldap_user_certificate = userCertificate;binary</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Add the following lines at the end of <code>/etc/sssd/sssd.conf</code></p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[pam]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pam_cert_auth = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Edit <code>/etc/krb5.conf</code> and add the following lines under <code>[realms]</code> replacing <code>*DOMAIN*</code> with your domain&#x27;s FQDN in all uppercase. This is to resolve a mismatch that can occur because Linux is case senstive while Windows is not.</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">*DOMAIN* = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pkinit_anchors = DIR:/etc/sssd/pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pkinit_kdc_hostname = *DOMAIN*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Use one of the following commands to enable smartcard authentication in PAM</p><ul><li><code>authselect enable-feature with-smartcard</code><br>This will allow smartcard authentication as an option</li><li><code>authselect enable-feature with-smartcard-required</code><br>This will require smartcard authentication. Please remember that, by default, SSHd will not call PAM when authenticating with SSH keys</li><li><code>authselect enable-feature with-smartcard-lock-on-removal</code><br>This will require smartcard authentication and will lock the machine when the smartcard is removed. Please remember that, by default, SSHd will not call PAM when authenticating with SSH keys</li></ul></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enable-ssh-access-using-the-smartcard-certificate">Enable SSH access using the smartcard certificate<a href="#enable-ssh-access-using-the-smartcard-certificate" class="hash-link" aria-label="Direct link to Enable SSH access using the smartcard certificate" title="Direct link to Enable SSH access using the smartcard certificate">​</a></h3><p>This only seems to work on RHEL 8 or above.  </p><ol><li>Verify that the smartcard cert will be read properly from AD by running the following command<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sss_ssh_authorizedkeys </span><span class="token variable" style="color:#36acaa">${</span><span class="token variable environment constant" style="color:#36acaa">USER</span><span class="token variable" style="color:#36acaa">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>If a public key is not returned, verify that smartcard authentication is configured properly</li><li>Edit <code>/etc/ssh/sshd_config</code> and add the following lines<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizedKeysCommand /usr/bin/sss_ssh_authorizedkeys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizedKeysCommandUser nobody</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Restart <code>sshd</code><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart sshd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>To SSH from a client, use the <code>ssh</code> option <code>PKCS11Provider /usr/lib64/opensc-pkcs11.so</code>. If the smartcard matches a public key for the user, it will then prompt for the smartcard pin/password.  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> -o </span><span class="token assign-left variable" style="color:#36acaa">PKCS11Provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/lib64/opensc-pkcs11.so *host*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-that-has-been-done">Testing that has been done<a href="#testing-that-has-been-done" class="hash-link" aria-label="Direct link to Testing that has been done" title="Direct link to Testing that has been done">​</a></h2><ul><li>Disabling a user within AD will immediately block access to the machine.<br>Just like with Windows, anyone who is already logged in will stay logged in.</li><li>Modification to the user&#x27;s groups is updated during login just like Windows. This is done before checking if they are allowed to log in.</li><li>SSSD is site aware. If you configure sites within <code>Sites and Services</code>, SSSD will connect to the appropriate DC.</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/active-directory"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Active Directory</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuring-your-ad-groups-for-rbac-role-based-access-control" class="table-of-contents__link toc-highlight">Configuring your AD groups for RBAC (Role Based Access Control)</a><ul><li><a href="#access-to-specific-machines" class="table-of-contents__link toc-highlight">Access to specific machines</a></li><li><a href="#access-to-all-machines" class="table-of-contents__link toc-highlight">Access to all machines</a></li><li><a href="#nesting" class="table-of-contents__link toc-highlight">Nesting</a></li></ul></li><li><a href="#domain-joining-your-linux-machine" class="table-of-contents__link toc-highlight">Domain Joining your Linux machine</a></li><li><a href="#keeping-the-os-information-up-to-date" class="table-of-contents__link toc-highlight">Keeping the OS information up to date</a></li><li><a href="#enabling-smartcard-authentication" class="table-of-contents__link toc-highlight">Enabling Smartcard authentication</a><ul><li><a href="#enable-ssh-access-using-the-smartcard-certificate" class="table-of-contents__link toc-highlight">Enable SSH access using the smartcard certificate</a></li></ul></li><li><a href="#testing-that-has-been-done" class="table-of-contents__link toc-highlight">Testing that has been done</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/red-hat">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8067824e.js"></script>
<script src="/assets/js/main.958d5789.js"></script>
</body>
</html>